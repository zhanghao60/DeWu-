# 小米手机（MIUI）故障排除指南

## 🚨 应用崩溃问题解决方案

### 1. 权限设置

#### 无障碍服务权限
1. 打开 **设置** → **更多设置** → **无障碍**
2. 找到 **得物自动化脚本** 服务
3. 点击进入，开启服务
4. 如果找不到服务，请重启应用后再试

#### 截屏权限（重要）
1. 点击"启动脚本"按钮时，系统会请求截屏权限
2. 在弹出的权限请求对话框中点击"立即开始"
3. 如果权限被拒绝，请到 **设置** → **应用管理** → **得物自动化脚本** → **权限管理** 中重新授权

#### MIUI 12+ 特殊设置
1. 打开 **设置** → **应用设置** → **应用管理**
2. 找到 **得物自动化脚本**
3. 点击 **权限管理**
4. 确保以下权限已开启：
   - ✅ 无障碍服务
   - ✅ 悬浮窗权限
   - ✅ 后台运行权限
   - ✅ 自启动权限

### 2. MIUI 优化设置

#### 关闭 MIUI 优化（重要）
1. 打开 **设置** → **更多设置** → **开发者选项**
2. 找到 **MIUI优化** 选项
3. 关闭 MIUI 优化
4. 重启手机

#### 省电模式设置
1. 打开 **设置** → **电池与性能**
2. 关闭 **省电模式**
3. 将应用设置为 **无限制**

### 3. 应用权限详细设置

#### 悬浮窗权限
1. **设置** → **应用设置** → **权限管理** → **悬浮窗**
2. 找到 **得物自动化脚本**
3. 开启悬浮窗权限

#### 后台运行权限
1. **设置** → **应用设置** → **应用管理** → **得物自动化脚本**
2. 点击 **省电策略**
3. 选择 **无限制**

#### 自启动权限
1. **设置** → **应用设置** → **应用管理** → **得物自动化脚本**
2. 开启 **自启动** 权限

### 4. 开发者选项设置

#### 开启开发者选项
1. **设置** → **我的设备** → **全部参数**
2. 连续点击 **MIUI版本** 7次
3. 返回设置，找到 **更多设置** → **开发者选项**

#### 重要开发者选项
- ✅ **USB调试**：开启
- ✅ **USB安装**：开启
- ✅ **USB调试（安全设置）**：开启
- ✅ **保持唤醒状态**：开启

### 5. 常见问题解决

#### 问题1：点击启动脚本后应用崩溃
**解决方案：**
1. 确保无障碍服务已正确开启
2. 关闭 MIUI 优化
3. 重启应用
4. 检查是否有其他安全软件干扰

#### 问题1.1：MediaProjection 权限错误
**错误信息：** `Media projections require a foreground service of type ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PROJECTION`

**解决方案：**
1. 确保应用版本是最新的（已修复此问题）
2. 重新安装应用
3. 在权限请求时点击"立即开始"
4. 如果仍有问题，请重启手机

#### 问题1.2：MediaProjection 回调错误
**错误信息：** `Must register a callback before starting capture, to manage resources in response to MediaProjection states.`

**解决方案：**
1. 确保应用版本是最新的（已修复此问题）
2. 重新安装应用
3. 这是 Android 14+ 的新要求，应用已自动处理

#### 问题1.3：ImageReader 线程错误
**错误信息：** `handler is null but the current thread is not a looper`

**解决方案：**
1. 确保应用版本是最新的（已修复此问题）
2. 重新安装应用
3. 这是线程管理问题，应用已自动处理

#### 问题2：无法截屏
**解决方案：**
1. 确保已授予截屏权限
2. 关闭省电模式
3. 检查是否有其他应用占用截屏功能

#### 问题3：脚本执行中断
**解决方案：**
1. 确保应用有后台运行权限
2. 关闭省电模式
3. 将应用加入白名单

### 6. 系统版本兼容性

#### MIUI 12 及以下版本
- 相对兼容性较好
- 主要注意权限设置

#### MIUI 13 及以上版本
- 需要额外设置
- 建议关闭 MIUI 优化
- 可能需要手动授权更多权限

### 7. 联系支持

如果按照以上步骤仍无法解决问题，请提供以下信息：
- 手机型号
- MIUI 版本号
- Android 版本
- 错误日志（如果可能）

---

## 📱 快速检查清单

- [ ] 无障碍服务已开启
- [ ] 悬浮窗权限已授予
- [ ] 后台运行权限已设置
- [ ] 自启动权限已开启
- [ ] MIUI 优化已关闭
- [ ] 省电模式已关闭
- [ ] 开发者选项已开启
- [ ] 应用已重启

完成以上所有步骤后，应用应该可以正常运行。