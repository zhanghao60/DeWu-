# 自动化脚本使用指南

## 🚀 快速开始

### 首次使用必读
1. **安装应用**后，点击"启动脚本"按钮
2. **开启无障碍服务**：系统会提示，点击确定跳转到设置页面开启
3. **授予悬浮窗权限**：系统会提示，点击"允许显示在其他应用上层"
4. **授予截屏权限**：系统会提示，点击"立即开始"
5. **设置后台权限**：设置 → 应用设置 → 应用管理 → 得物自动化脚本 → 省电策略 → 无限制
6. **开启自启动**：设置 → 应用设置 → 应用管理 → 得物自动化脚本 → 自启动

### ⚠️ 重要提醒
- **悬浮窗权限**是必需的，用于防止应用被后台杀死
- **MIUI用户**需要额外设置：关闭MIUI优化、锁定应用、关闭省电模式
- **详细权限设置**：请参考 [权限设置指南](PERMISSION_SETUP_GUIDE.md)
- 下方"权限要求"部分提供简要说明

---

自动化脚本功能可以自动执行以下操作：
1. 从JSON文件中读取保存的URL列表
2. 在浏览器中逐个打开每个URL
3. 等待10秒让页面完全加载
4. 截取屏幕截图并保存为JPG格式
5. 将截图发送POST请求到指定的API接口
6. 根据API返回的坐标点击页面
7. 智能查找目标控件（支持滑动查找）
8. 对每个控件执行循环操作（点击->等待->返回）

## 新增功能

### 🎯 智能控件操作
- **自动查找控件**：查找页面中的 `imgPhoto` 控件
- **智能滑动查找**：
  - 找到2个控件后自动向下滑动，继续查找
  - 到底部后自动向上滑动
  - 最多查找12个控件
- **边找边操作**：找到2个 → 操作 → 滑动 → 继续找下2个
- **循环点击**：对每个控件执行5次"点击->等待->返回"操作
- **可自定义**：等待时间、点击后是否向左滑动

### 🔧 脚本设置
- **自定义等待时间**：设置每次点击后等待的时间（毫秒）
- **点击后向左滑动**：启用后，每次点击控件后会向左滑动一次（用于切换图片）
- **设置持久化**：设置会自动保存，下次启动继续使用

### 🎈 悬浮窗显示
- **实时状态显示**：在屏幕右上角显示脚本执行状态
- **防止后台杀死**：悬浮窗让系统认为应用正在使用，避免被MIUI清理
- **状态更新**：实时显示当前处理的控件和循环次数
- **暂停/继续**：点击悬浮窗可暂停脚本，再次点击继续执行
- **可拖动**：长按拖动可调整悬浮窗位置

## 使用步骤

### 1. 准备工作

#### 1.1 添加URL
- 点击"管理链接"按钮
- 添加需要处理的网页链接
- 点击"保存到文件"将链接保存到JSON文件

#### 1.2 配置脚本参数
- 点击"脚本设置"按钮
- 设置自定义等待时间（建议2000-5000毫秒）
- 选择是否启用滑动查找
- 点击"保存设置"

#### 1.3 启用必要权限（重要！）

**⚠️ 权限说明：**
应用需要以下权限才能正常运行，请务必按照步骤开启：

**无障碍服务**：
- 点击"启动脚本"按钮
- 系统会提示启用无障碍服务
- 在无障碍设置中找到"得物自动化脚本"并开启
- 路径：设置 → 更多设置 → 无障碍 → 得物自动化脚本

**悬浮窗权限**（重要！防止被后台杀死）：
- 首次启动脚本会提示授予悬浮窗权限
- 点击"允许显示在其他应用上层"
- 此权限可防止应用在后台被MIUI清理
- 路径：设置 → 应用设置 → 权限管理 → 悬浮窗 → 得物自动化脚本

**截屏权限**：
- 点击"启动脚本"按钮时，系统会请求截屏权限
- 在弹出的权限请求对话框中点击"立即开始"
- 如果权限被拒绝，请到设置中重新授权

**后台服务权限**：
- 设置 → 应用设置 → 应用管理 → 得物自动化脚本
- 点击"省电策略" → 选择"无限制"
- 开启"自启动"权限
- 确保"后台运行权限"已开启

### 2. 执行自动化脚本

#### 2.1 启动脚本
1. **检查权限状态**：
   - ✅ 无障碍服务已启用
   - ✅ 悬浮窗权限已授予
   - ✅ 截屏权限已授予
   - ✅ 后台服务权限已设置
2. 点击"启动脚本"按钮
3. 系统会请求截屏权限，点击"立即开始"
4. 脚本开始自动执行

#### 2.2 脚本执行过程
- 屏幕右上角出现悬浮窗显示"脚本初始化中...（点击暂停）"
- 通知栏出现"自动化脚本正在执行中..."
- 系统会逐个处理每个URL
- 每个URL的处理过程：
  1. 在浏览器中打开URL
  2. 等待10秒让页面加载
  3. 截取屏幕截图
  4. 将截图发送到API
  5. 根据API返回坐标点击页面
  6. 等待3秒页面加载
  7. 查找目标控件（imgPhoto）：
     - 查找当前屏幕的2个控件
     - 立即操作这2个控件（每个5次循环）
     - 向下滑动查找下2个
     - 到底部后向上滑动继续查找
     - 最多操作12个控件
  8. 对每个控件执行5次循环：
     - 点击控件
     - 【可选】向左滑动（如果在设置中启用）
     - 等待（自定义时间）
     - 点击返回

#### 2.3 暂停/继续功能
- **暂停**：点击悬浮窗，显示"⏸ 已暂停（点击继续）"
- **继续**：再次点击悬浮窗，脚本继续执行
- **拖动**：长按悬浮窗可拖动到其他位置
- **暂停时机**：脚本会在安全的位置响应暂停（循环开始前、控件切换前等）

#### 2.4 执行结果
- 悬浮窗实时显示执行状态
- 截图保存在应用目录的screenshots文件夹中
- 控制台输出详细的执行日志
- 脚本完成后悬浮窗和通知自动消失

## 技术细节

### API接口
- **URL**: `https://cv.ljzzh.cn/api/cv`
- **方法**: POST
- **格式**: multipart/form-data
- **参数**:
  - `image`: 截图文件 (JPG格式)
  - `url`: 原始URL地址

### 文件结构
```
app/src/main/java/com/zh/dewuautomationscript/
├── AutomationScriptExecutor.java  # 脚本执行器（流程编排）
├── ScriptUtils.java              # 脚本工具类（提供所有基础方法）
├── SettingsManager.java          # 设置管理（保存用户配置）
├── MainActivity.java              # 主界面
├── SettingsActivity.java         # 设置界面
├── UrlManagerActivity.java       # URL管理界面
├── HelpActivity.java             # 帮助文档界面
├── JsonFileManager.java          # JSON文件管理
├── ScreenshotHelper.java         # 截屏工具
├── FloatingWindowService.java    # 悬浮窗服务
├── MediaProjectionService.java   # 前台服务
└── AutomationAccessibilityService.java  # 无障碍服务
```

### 架构说明

项目采用分层架构，职责明确：

#### ScriptUtils.java - 脚本工具类
提供所有自动化脚本的基础方法，其他代码只需调用这些方法即可：

**基础操作方法**：
- `Click(x, y)` - 根据坐标点击
- `ElementClick(elementId)` - 根据控件点击（支持viewId和文本）
- `GoBack()` - 返回操作
- `Swipe(startX, startY, endX, endY, duration)` - 滑动操作
- `OpenUrl(url)` - 在浏览器中打开URL
- `Sleep(milliseconds)` - 等待指定时间

**图像处理方法**：
- `GetScreenShot(fileName)` - 截取屏幕截图
- `PostImg(imagePath, apiUrl, originalUrl, callback)` - 发送图片到指定URL

**解析方法**：
- `ParseCoordinate(responseBody)` - 解析API响应中的坐标
- `GetAllElements()` - 获取当前页面控件布局（待实现）

#### AutomationScriptExecutor.java - 脚本执行器
负责编排脚本执行流程，不关心具体实现：
- 读取URL列表
- 循环处理每个URL
- 调用ScriptUtils的方法完成具体操作
- 管理回调和异常处理

这种设计使得：
1. **代码复用**：所有脚本都可以使用ScriptUtils的方法
2. **易于扩展**：添加新的自动化方法只需在ScriptUtils中添加
3. **职责清晰**：执行器负责流程，工具类负责实现
4. **便于维护**：修改某个功能只需修改对应的工具方法

### 权限要求
- **无障碍服务权限**（必需）- 用于控件操作和点击
- **悬浮窗权限**（必需）- 防止应用被后台杀死
- **截屏权限**（MediaProjection，必需）- 用于截取屏幕
- **网络权限** - 发送API请求
- **存储权限** - 保存截图文件
- **WakeLock权限** - 防止CPU休眠

## 注意事项

### 1. 权限要求（重要！）

> **📖 详细设置指南**：请参考 [权限设置指南](PERMISSION_SETUP_GUIDE.md) 获取完整的权限设置步骤和故障排除方法。

#### 🔧 必需权限
- **无障碍服务权限**（必需）- 用于控件操作和点击
- **悬浮窗权限**（必需）- 防止应用被后台杀死
- **截屏权限**（MediaProjection，必需）- 用于截取屏幕
- **网络权限** - 发送API请求
- **存储权限** - 保存截图文件
- **WakeLock权限** - 防止CPU休眠

#### 📱 权限开启步骤

**1. 无障碍服务权限**
- 点击"启动脚本"按钮
- 系统会提示启用无障碍服务
- 在无障碍设置中找到"得物自动化脚本"并开启
- 路径：设置 → 更多设置 → 无障碍 → 得物自动化脚本

**2. 悬浮窗权限（重要！防止被后台杀死）**
- 首次启动脚本会提示授予悬浮窗权限
- 点击"允许显示在其他应用上层"
- 此权限可防止应用在后台被MIUI清理
- 路径：设置 → 应用设置 → 权限管理 → 悬浮窗 → 得物自动化脚本

**3. 截屏权限**
- 点击"启动脚本"按钮时，系统会请求截屏权限
- 在弹出的权限请求对话框中点击"立即开始"
- 如果权限被拒绝，请到设置中重新授权

**4. 后台服务权限**
- 设置 → 应用设置 → 应用管理 → 得物自动化脚本
- 点击"省电策略" → 选择"无限制"
- 开启"自启动"权限
- 确保"后台运行权限"已开启

#### ✅ 权限检查清单
在启动脚本前，请确认以下权限都已正确设置：

- [ ] **无障碍服务**：设置 → 更多设置 → 无障碍 → 得物自动化脚本（已开启）
- [ ] **悬浮窗权限**：设置 → 应用设置 → 权限管理 → 悬浮窗 → 得物自动化脚本（已开启）
- [ ] **截屏权限**：启动脚本时会自动请求，点击"立即开始"
- [ ] **后台权限**：设置 → 应用设置 → 应用管理 → 得物自动化脚本 → 省电策略 → 无限制
- [ ] **自启动权限**：设置 → 应用设置 → 应用管理 → 得物自动化脚本 → 自启动（已开启）
- [ ] **网络权限**：确保设备已连接网络
- [ ] **存储权限**：用于保存截图文件

**MIUI用户额外检查：**
- [ ] **应用锁定**：最近任务 → 得物自动化脚本 → 下拉锁定
- [ ] **关闭省电模式**：设置 → 电池与性能 → 关闭省电模式
- [ ] **关闭MIUI优化**：设置 → 更多设置 → 开发者选项 → 关闭MIUI优化

### 2. MIUI特殊要求（重要！）
为确保脚本在后台正常执行，MIUI用户需要：

**方案1：应用锁定（推荐）**
- 打开"最近任务"
- 找到"得物自动化脚本"应用卡片
- 下拉卡片，点击🔒图标锁定

**方案2：关闭电池优化**
- 设置 → 应用设置 → 应用管理
- 找到"得物自动化脚本"
- 电池 → 无限制

**方案3：自启动权限**
- 设置 → 应用设置 → 应用管理
- 找到"得物自动化脚本"
- 自启动 → 开启

### 3. 使用限制
- 脚本需要在前台或悬浮窗保护下运行
- 建议在WiFi环境下使用以节省流量
- 确保目标网站可以正常访问
- 单次最多操作12个控件

### 4. 错误处理
- 如果某个URL处理失败，会继续处理下一个
- 控件查找失败会记录日志
- 可以查看日志了解详细错误信息

### 5. 性能考虑
- 每个URL处理需要至少10秒（等待时间）
- 每个控件循环5次，根据等待时间不同，总时长会有差异
- 启用滑动会增加查找时间
- 截图文件会占用存储空间
- 建议定期清理截图文件

## 故障排除

> **📖 详细故障排除**：请参考 [权限设置指南](PERMISSION_SETUP_GUIDE.md) 获取完整的故障排除方法和常见问题解决方案。

### 🚨 权限问题（最常见）

#### 脚本无法启动
1. **检查无障碍服务**：设置 → 更多设置 → 无障碍 → 得物自动化脚本（必须开启）
2. **检查悬浮窗权限**：设置 → 应用设置 → 权限管理 → 悬浮窗 → 得物自动化脚本（必须开启）
3. **检查后台权限**：设置 → 应用设置 → 应用管理 → 得物自动化脚本 → 省电策略 → 无限制
4. **检查自启动权限**：设置 → 应用设置 → 应用管理 → 得物自动化脚本 → 自启动（必须开启）
5. 确认JSON文件中是否有URL
6. 检查网络连接

#### 脚本执行中断
1. **MIUI用户特别注意**：
   - 打开"最近任务"
   - 找到"得物自动化脚本"应用卡片
   - 下拉卡片，点击🔒图标锁定应用
2. **关闭省电模式**：设置 → 电池与性能 → 关闭省电模式
3. **关闭MIUI优化**：设置 → 更多设置 → 开发者选项 → 关闭MIUI优化
4. 确保应用有后台运行权限
5. 将应用加入白名单

### 截图失败
1. 确认截屏权限已授予
2. 检查无障碍服务状态
3. 确认设备支持截屏功能

### API请求失败
1. 检查网络连接
2. 确认API地址是否正确
3. 检查服务器是否可访问

### 浏览器无法打开URL
1. 检查URL格式是否正确
2. 确认设备已安装浏览器
3. 检查URL是否可访问

## 开发说明

### 自定义配置
可以在`AutomationScriptExecutor.java`中修改：
- 等待时间（默认10秒）
- API地址
- 错误重试次数

可以在`ScriptUtils.java`中修改：
- 截图格式和质量
- 网络请求参数

### 如何使用ScriptUtils编写自定义脚本

ScriptUtils提供了所有基础方法，你可以轻松编写自定义脚本：

```java
// 示例1: 简单的点击脚本
ScriptUtils scriptUtils = new ScriptUtils(context, screenshotHelper, httpClient);
scriptUtils.OpenUrl("https://example.com");
scriptUtils.Sleep(3000);  // 等待3秒
scriptUtils.Click(500, 800);  // 点击坐标(500, 800)
scriptUtils.GoBack();  // 返回

// 示例2: 截图并发送到API
String screenshot = scriptUtils.GetScreenShot("my_screenshot.jpg");
if (screenshot != null) {
    scriptUtils.PostImg(screenshot, "https://api.example.com", "https://example.com", 
        new ScriptUtils.PostImgCallback() {
            @Override
            public void onSuccess(String response) {
                // 处理成功响应
                ScriptUtils.Coordinate coord = scriptUtils.ParseCoordinate(response);
                if (coord != null) {
                    scriptUtils.Click(coord.x, coord.y);
                }
            }
            
            @Override
            public void onFailure(String error) {
                // 处理失败
                Log.e("Script", "Failed: " + error);
            }
        });
}
```

### 扩展功能
- 在`ScriptUtils.java`中添加新的自动化方法
- 实现待完成的方法（ElementClick、GetAllElements）
- 可以自定义截图保存路径
- 可以添加更多的API参数
- 可以添加执行日志记录

## 版本信息

- 当前版本：1.0.0
- 支持Android版本：7.0+ (API 24+)
- 依赖库：OkHttp 4.12.0
